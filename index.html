<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üöó H·ªá th·ªëng gi√°m s√°t t√†i x·∫ø</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #0a0a0a; min-height: 100vh; display: flex; justify-content: center; align-items: center; padding: 20px; color: #ffffff; }
        .container { background: #141414; border-radius: 24px; border: 1px solid #2a2a2a; overflow: hidden; max-width: 1400px; width: 100%; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.8); }
        .header { background: linear-gradient(135deg, #1a1a1a 0%, #0a0a0a 100%); padding: 32px 40px; border-bottom: 1px solid #2a2a2a; display: flex; align-items: center; gap: 24px; }
        .header-logo { width: 80px; height: 80px; flex-shrink: 0; }
        .header-content { flex: 1; }
        .header h1 { font-size: 1.75em; font-weight: 600; margin-bottom: 8px; background: linear-gradient(135deg, #ffffff 0%, #a0a0a0 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .header p { color: #888; font-size: 0.95em; }
        .main-content { padding: 40px; display: grid; grid-template-columns: 1fr 320px; gap: 30px; }
        @media (max-width: 1024px) { .main-content { grid-template-columns: 1fr; } }
        .video-section { display: flex; flex-direction: column; gap: 20px; }
        .video-container { position: relative; background: #000; border-radius: 16px; overflow: hidden; border: 1px solid #2a2a2a; width: 100%; height: auto; min-height: 480px; display: flex; justify-content: center; align-items: center; }
        
        video { width: 100%; height: auto; display: block; object-fit: contain; transform: scaleX(-1); }
        canvas { position: absolute; top: 0; left: 0; right: 0; bottom: 0; width: 100% !important; height: 100% !important; transform: scaleX(-1); object-fit: contain; margin: auto; }
        
        .alert-drowsy, .alert-hands, .alert-yawn, .alert-sos {
            position: absolute; left: 0; right: 0; padding: 24px; text-align: center;
            font-size: 1.25em; font-weight: 600; animation: alertPulse 1s infinite;
            display: none; z-index: 10; backdrop-filter: blur(8px);
        }
        .alert-drowsy { top: 0; background: rgba(220, 38, 38, 0.95); color: white; border-bottom: 2px solid rgba(255, 255, 255, 0.2); }
        .alert-hands { bottom: 0; background: rgba(245, 158, 11, 0.95); color: white; border-top: 2px solid rgba(255, 255, 255, 0.2); }
        .alert-yawn { top: 80px; background: rgba(147, 51, 234, 0.95); color: white; border: 2px solid rgba(255, 255, 255, 0.2); border-radius: 12px; margin: 0 20px; }
        
        .alert- {
            top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 80%; height: auto;
            background: rgba(255, 0, 0, 0.95); color: white;
            border: 4px solid #fff; border-radius: 16px;
            font-size: 2em; padding: 40px;
            animation: sosFlash 0.5s infinite;
            z-index: 50;
        }

        @keyframes alertPulse { 0%, 100% { opacity: 1; transform: scale(1); } 50% { opacity: 0.85; transform: scale(0.98); } }
        @keyframes sosFlash { 0%, 100% { background: rgba(255, 0, 0, 0.95); } 50% { background: #000; } }

        .info-overlay { position: absolute; top: 16px; left: 16px; background: rgba(0, 0, 0, 0.8); backdrop-filter: blur(10px); padding: 12px 16px; border-radius: 12px; font-size: 0.85em; z-index: 5; border: 1px solid rgba(255, 255, 255, 0.1); }
        .info-overlay div { display: flex; align-items: center; gap: 8px; margin-bottom: 6px; }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; background: #10b981; animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7); } 50% { opacity: 0.8; box-shadow: 0 0 0 4px rgba(16, 185, 129, 0); } }
        .fps-counter { position: absolute; top: 16px; right: 16px; background: rgba(0, 0, 0, 0.8); padding: 8px 12px; border-radius: 8px; font-size: 0.85em; font-weight: 600; z-index: 5; color: #10b981; border: 1px solid rgba(16, 185, 129, 0.3); }
        .loading { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); padding: 32px; background: rgba(0, 0, 0, 0.9); border-radius: 16px; z-index: 20; border: 1px solid #2a2a2a; text-align: center; color: #888; }
        
        .controls { display: flex; gap: 12px; }
        button { flex: 1; padding: 16px; font-size: 0.95em; border: none; border-radius: 12px; cursor: pointer; transition: all 0.2s ease; font-weight: 600; color: white; }
        .btn-start { background: #10b981; } .btn-start:hover:not(:disabled) { background: #059669; }
        .btn-stop { background: #ef4444; } .btn-stop:hover:not(:disabled) { background: #dc2626; }
        button:disabled { background: #2a2a2a; color: #666; cursor: not-allowed; }
        
        .sidebar { display: flex; flex-direction: column; gap: 24px; }
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .stat-card { background: #1a1a1a; border: 1px solid #2a2a2a; padding: 20px; border-radius: 12px; text-align: center; }
        .stat-card h3 { font-size: 0.8em; color: #888; margin-bottom: 8px; text-transform: uppercase; }
        .stat-card .value { font-size: 2em; font-weight: 700; background: linear-gradient(135deg, #ffffff 0%, #a0a0a0 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        
        .settings-panel { background: #1a1a1a; border: 1px solid #2a2a2a; border-radius: 16px; padding: 24px; }
        .settings-title { font-size: 1.1em; font-weight: 600; margin-bottom: 20px; color: #fff; }
        .setting-item { margin-bottom: 20px; }
        .setting-label { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; font-size: 0.85em; color: #aaa; }
        input[type="range"] { width: 100%; height: 6px; background: #2a2a2a; border-radius: 3px; }
        input[type="number"], input[type="text"] { width: 100%; padding: 8px 12px; background: #0a0a0a; border: 1px solid #2a2a2a; border-radius: 8px; color: #fff; outline: none; }
        input[type="number"] { width: 80px; }
        .divider { height: 1px; background: #2a2a2a; margin: 20px 0; }
        
        .sos-timer {
            margin-top: 10px;
            padding: 10px;
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid rgba(239, 68, 68, 0.5);
            border-radius: 8px;
            color: #fca5a5;
            text-align: center;
            font-size: 0.9em;
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-content">
                <h1>üöó H·ªá th·ªëng gi√°m s√°t t√†i x·∫ø</h1>
                <p>Ph√°t hi·ªán Ng·ªß g·∫≠t, Ng√°p & Tay r·ªùi v√¥ lƒÉng + SOS Kh·∫©n c·∫•p</p>
            </div>
        </div>

        <div class="main-content">
            <div class="video-section">
                <div id="errorMessage" class="error-message" style="display:none; color:red; margin-bottom:10px;"></div>

                <div class="video-container">
                    <video id="video" autoplay playsinline></video>
                    <canvas id="canvas"></canvas>
                    
                    <div id="loading" class="loading">
                        <div>üì∏ H√£y cho ph√©p s·ª≠ d·ª•ng camera ƒë·ªÉ b·∫Øt ƒë·∫ßu gi√°m s√°t</div>
                    </div>
                    
                    <div id="alertDrowsy" class="alert-drowsy">‚ö†Ô∏è C·∫¢NH B√ÅO: T√ÄI X·∫æ NG·ª¶ G·∫¨T</div>
                    <div id="alertYawn" class="alert-yawn">ü•± C·∫¢NH B√ÅO: PH√ÅT HI·ªÜN NG√ÅP</div>
                    <div id="alertHands" class="alert-hands">‚ö†Ô∏è C·∫¢NH B√ÅO: TAY R·ªúI V√î LƒÇNG</div>
                    <div id="alertSOS" class="alert-sos">
                        üÜò KH·∫®N C·∫§P üÜò<br>
                        ƒêANG G·ªåI C·ª®U H·ªò!
                        <div style="font-size: 0.5em; margin-top: 10px; font-weight: normal;">Vui l√≤ng x√°c nh·∫≠n tr√™n ƒëi·ªán tho·∫°i...</div>
                    </div>

                    <div class="info-overlay">
                        <div><span>EAR (M·∫Øt):</span> <span id="earValue" style="color:#10b981;">0.00</span></div>
                        <div><span>MAR (Mi·ªáng):</span> <span id="marValue" style="color:#a78bfa;">0.00</span></div>
                        <div><div class="status-dot" id="mainStatusDot"></div> <span id="statusText">S·∫µn s√†ng</span></div>
                    </div>

                    <div class="fps-counter"><span id="fpsValue">0</span> FPS</div>
                </div>
                
                <div id="sosTimerDisplay" class="sos-timer">
                    ‚è≥ Nguy hi·ªÉm k√©o d√†i: <span id="sosTimeSeconds">0</span>s / <span id="sosLimitDisplay">180</span>s
                </div>

                <div class="controls">
                    <button class="btn-start" id="startBtn">B·∫Øt ƒë·∫ßu gi√°m s√°t</button>
                    <button class="btn-stop" id="stopBtn" disabled>D·ª´ng l·∫°i</button>
                </div>
            </div>

            <div class="sidebar">
                <div class="stats-grid">
                    <div class="stat-card"><h3>M·∫Øt nh·∫Øm</h3><div class="value" id="drowsyFramesCount">0</div></div>
                    <div class="stat-card"><h3>Ng√°p</h3><div class="value" id="yawnCount">0</div></div>
                    <div class="stat-card"><h3>Tay r·ªùi</h3><div class="value" id="handOffFramesCount">0</div></div>
                    <div class="stat-card"><h3>C·∫£nh b√°o</h3><div class="value" id="totalAlerts">0</div></div>
                </div>

                <div class="settings-panel">
                    <div class="settings-title">SOS</div>
                    
                    <div class="setting-item">
                        <div class="setting-label"><span>SƒêT Ng∆∞·ªùi th√¢n (Nh·∫≠n SOS)</span></div>
                        <input type="text" id="emergencyContact" placeholder="VD: 0987654321" value="">
                    </div>
                     <div class="setting-item">
                        <div class="setting-label"><span>Th·ªùi gian ch·ªù SOS (gi√¢y)</span></div>
                        <input type="number" id="sosTimeoutInput" value="180">
                    </div>

                    <div class="divider"></div>
                    <div class="settings-title">‚öôÔ∏è C√†i ƒë·∫∑t</div>

                    <div class="setting-item">
                        <div class="setting-label">
                            <span>Ng∆∞·ª°ng m·∫Øt (EAR)</span>
                            <input type="number" id="earThreshold" value="0.25" step="0.01">
                        </div>
                    </div>
                    <div class="setting-item">
                        <div class="setting-label">
                            <span>Ng∆∞·ª°ng mi·ªáng (MAR)</span>
                            <input type="number" id="marThreshold" value="0.5" step="0.05">
                        </div>
                    </div>    
                    <div class="setting-item">
                        <div class="setting-label">
                            <span>M·∫Øt nh·∫Øm (Frames)</span>
                            <input type="number" id="drowsyFrames" value="20" step="5" min="5" max="60">
                        </div>
                    </div>    
                    </div>
                    <div class="setting-item">
                        <div class="setting-label"><span>√Çm l∆∞·ª£ng</span> <span id="volumeValue">100%</span></div>
                        <input type="range" id="volumeSlider" min="0" max="100" value="100">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <audio id="drowsyAlert" src="https://files.catbox.moe/ou9wbx.mp3" preload="auto"></audio>
    <audio id="handOffAlert" src="https://files.catbox.moe/n49uum.mp3" preload="auto"></audio>
    <audio id="sosSound" src="https://cdn.pixabay.com/download/audio/2021/08/09/audio_14167e8c32.mp3" preload="auto"></audio>

    <script>
        if (location.protocol === 'file:') {
            alert("‚ö†Ô∏è C·∫¢NH B√ÅO: B·∫°n ƒëang m·ªü file tr·ª±c ti·∫øp!\nAI s·∫Ω kh√¥ng ho·∫°t ƒë·ªông.\nVui l√≤ng d√πng 'Open with Live Server' trong VS Code.");
        }

        let CONFIG = {
            EAR_THRESHOLD: 0.25,
            MAR_THRESHOLD: 0.5,
            DROWSY_FRAMES: 20,
            YAWN_FRAMES: 20,
            HAND_OFF_FRAMES: 30, 
            SOS_TIMEOUT_MS: 180000,
            WARMUP_SECONDS: 5,
            VOLUME: 1.0
        };

        let faceMesh, hands, camera;
        let isRunning = false;
        
        let systemStartTime = 0; 

        let earCounter = 0;
        let marCounter = 0;
        let handOffCounter = 0;
        let yawnTotal = 0;
        let alertTotal = 0;

        let isDrowsyAlerting = false;
        let isYawnAlerting = false;
        let isHandAlerting = false;
        let isSOSActive = false;

        let dangerStartTime = null; 
        
        let frameCount = 0; 
        let lastFpsTime = Date.now();

        const LEFT_EYE = [362, 385, 387, 263, 373, 380];
        const RIGHT_EYE = [33, 160, 158, 133, 153, 144];
        
        const els = {
            video: document.getElementById('video'),
            canvas: document.getElementById('canvas'),
            ctx: document.getElementById('canvas').getContext('2d'),
            fps: document.getElementById('fpsValue'),
            ear: document.getElementById('earValue'),
            mar: document.getElementById('marValue'),
            status: document.getElementById('statusText'),
            dot: document.getElementById('mainStatusDot'),
            sosTimer: document.getElementById('sosTimerDisplay'),
            sosSeconds: document.getElementById('sosTimeSeconds'),
            alertDrowsy: document.getElementById('alertDrowsy'),
            alertHands: document.getElementById('alertHands'),
            alertYawn: document.getElementById('alertYawn'),
            alertSOS: document.getElementById('alertSOS'),
            soundDrowsy: document.getElementById('drowsyAlert'),
            soundHand: document.getElementById('handOffAlert'),
            soundSOS: document.getElementById('sosSound')
        };

        (function injectHandSettings() {
            const marInput = document.getElementById('marThreshold');
            if(marInput) {
                const container = marInput.closest('.setting-item');
                const newDiv = document.createElement('div');
                newDiv.className = 'setting-item';
                newDiv.innerHTML = `
                    <div class="setting-label">
                        <span>Tay r·ªùi (Frames)</span>
                        <input type="number" id="handFrameInput" value="${CONFIG.HAND_OFF_FRAMES}" step="5">
                    </div>
                `;
                container.parentNode.insertBefore(newDiv, container.nextSibling);

                setTimeout(() => {
                    document.getElementById('handFrameInput').addEventListener('change', (e) => {
                        let val = parseInt(e.target.value);
                        if(val < 5) val = 5; 
                        CONFIG.HAND_OFF_FRAMES = val;
                    });
                }, 500);
            }
        })();

        function distance(p1, p2) {
            return Math.sqrt(Math.pow(p2.x - p1.x, 2) + Math.pow(p2.y - p1.y, 2));
        }

        function calculateEAR(landmarks, indices) {
            const p = indices.map(i => landmarks[i]);
            const A = distance(p[1], p[5]);
            const B = distance(p[2], p[4]);
            const C = distance(p[0], p[3]);
            return (A + B) / (2.0 * C);
        }

        function calculateMAR(landmarks) {
            const top = landmarks[13];
            const bottom = landmarks[14];
            const left = landmarks[61];
            const right = landmarks[291];
            return distance(top, bottom) / distance(left, right);
        }

        function playSound(audioEl) {
            if (!isRunning) { audioEl.pause(); return; }
            if (isSOSActive && audioEl !== els.soundSOS) return;
            audioEl.volume = CONFIG.VOLUME;
            audioEl.play().catch(e => {});
        }

        function checkSOSStatus() {
            if (!isRunning) return;
            
            if (isDrowsyAlerting || isHandAlerting) {
                if (!dangerStartTime) {
                    dangerStartTime = Date.now();
                    els.sosTimer.style.display = 'block';
                }

                const elapsed = Date.now() - dangerStartTime;
                const seconds = Math.floor(elapsed / 1000);
                els.sosSeconds.textContent = seconds;
                document.getElementById('sosLimitDisplay').textContent = CONFIG.SOS_TIMEOUT_MS / 1000;

                if (elapsed > CONFIG.SOS_TIMEOUT_MS && !isSOSActive) {
                    triggerSOS();
                }
            } else {
                dangerStartTime = null;
                els.sosTimer.style.display = 'none';
                if(isSOSActive) stopSOS();
            }
        }

        function triggerSOS() {
            if (!isRunning) return;
            isSOSActive = true;
            els.alertSOS.style.display = 'block';
            els.soundSOS.loop = true;
            playSound(els.soundSOS);
            
            const phone = document.getElementById('emergencyContact').value;
            const msg = "KH·∫®N C·∫§P: T√†i x·∫ø xe ƒëang g·∫∑p nguy hi·ªÉm (kh√¥ng ph·∫£n h·ªìi).";
            
            if (phone) {
                setTimeout(() => {
                   if(isRunning) window.location.href = `sms:${phone}?body=${encodeURIComponent(msg)}`;
                }, 1000);
            }
        }

        function stopSOS() {
            isSOSActive = false;
            els.alertSOS.style.display = 'none';
            els.soundSOS.pause();
            els.soundSOS.currentTime = 0;
        }

        function checkWarmUp() {
            const elapsed = Date.now() - systemStartTime;
            if (elapsed < CONFIG.WARMUP_SECONDS * 1000) {
                els.status.textContent = `ƒêang ·ªïn ƒë·ªãnh... (${Math.ceil(CONFIG.WARMUP_SECONDS - elapsed/1000)}s)`;
                els.dot.style.background = "#fbbf24"; 
                earCounter = 0;
                marCounter = 0;
                handOffCounter = 0;
                return true; 
            }
            return false; 
        }

        function onFaceResults(results) {
            if (!isRunning) return; 

            if (!results.multiFaceLandmarks || results.multiFaceLandmarks.length === 0) return;
            const landmarks = results.multiFaceLandmarks[0];

            window.drawConnectors(els.ctx, landmarks, window.FACEMESH_TESSELATION, {color: '#3a3a3a40', lineWidth: 1});

            if (checkWarmUp()) return;

            const leftEAR = calculateEAR(landmarks, LEFT_EYE);
            const rightEAR = calculateEAR(landmarks, RIGHT_EYE);
            const avgEAR = (leftEAR + rightEAR) / 2.0;
            els.ear.textContent = avgEAR.toFixed(2);

            if (avgEAR < CONFIG.EAR_THRESHOLD) {
                earCounter++;
                if (earCounter >= CONFIG.DROWSY_FRAMES) {
                    if (!isDrowsyAlerting) {
                        isDrowsyAlerting = true;
                        alertTotal++;
                        els.alertDrowsy.style.display = 'block';
                        playSound(els.soundDrowsy);
                    }
                }
            } else {
                earCounter = 0;
                isDrowsyAlerting = false;
                els.alertDrowsy.style.display = 'none';
            }
            document.getElementById('drowsyFramesCount').textContent = earCounter;

            const mar = calculateMAR(landmarks);
            els.mar.textContent = mar.toFixed(2);

            if (mar > CONFIG.MAR_THRESHOLD) {
                marCounter++;
                window.drawConnectors(els.ctx, landmarks, window.FACEMESH_LIPS, {color: '#ef4444', lineWidth: 3});
                if (marCounter >= CONFIG.YAWN_FRAMES) {
                    if (!isYawnAlerting) {
                        isYawnAlerting = true;
                        yawnTotal++;
                        alertTotal++;
                        document.getElementById('yawnCount').textContent = yawnTotal;
                        els.alertYawn.style.display = 'block';
                    }
                }
            } else {
                marCounter = 0;
                isYawnAlerting = false;
                els.alertYawn.style.display = 'none';
                window.drawConnectors(els.ctx, landmarks, window.FACEMESH_LIPS, {color: '#10b981', lineWidth: 1});
            }
            document.getElementById('totalAlerts').textContent = alertTotal;
        }

        function onHandsResults(results) {
            if (!isRunning) return;

            let handsDetected = results.multiHandLandmarks && results.multiHandLandmarks.length > 0;

            if (handsDetected) {
                for (const landmarks of results.multiHandLandmarks) {
                    window.drawConnectors(els.ctx, landmarks, window.HANDS_CONNECTIONS, {color: '#10b981', lineWidth: 3});
                    window.drawLandmarks(els.ctx, landmarks, {color: '#ef4444', lineWidth: 1, radius: 3});
                }
                
                if (checkWarmUp()) return;

                handOffCounter = 0;
                isHandAlerting = false;
                els.alertHands.style.display = 'none';
                els.status.textContent = "Tay tr√™n v√¥ lƒÉng";
                els.dot.style.background = "#10b981";
            } else {
                if (checkWarmUp()) return;

                handOffCounter++;
                if (handOffCounter >= CONFIG.HAND_OFF_FRAMES) {
                    if (!isHandAlerting) {
                        isHandAlerting = true;
                        alertTotal++;
                        els.alertHands.style.display = 'block';
                        playSound(els.soundHand);
                    }
                    els.status.textContent = "KH√îNG TH·∫§Y TAY!";
                    els.dot.style.background = "#ef4444";
                }
            }
            document.getElementById('handOffFramesCount').textContent = handOffCounter;
        }

        async function setupAI() {
            if (!faceMesh) {
                faceMesh = new FaceMesh({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}`});
                faceMesh.setOptions({maxNumFaces: 1, refineLandmarks: true, minDetectionConfidence: 0.5, minTrackingConfidence: 0.5});
                faceMesh.onResults(onFaceResults);
            }

            if (!hands) {
                hands = new Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
                hands.setOptions({maxNumHands: 2, modelComplexity: 0, minDetectionConfidence: 0.5, minTrackingConfidence: 0.5});
                hands.onResults(onHandsResults);
            }

            if (!camera) {
                const video = els.video;
                camera = new Camera(video, {
                    onFrame: async () => {
                        if (!isRunning) return;
                        
                        if (els.canvas.width === 0) {
                            els.canvas.width = video.videoWidth;
                            els.canvas.height = video.videoHeight;
                        }

                        els.ctx.clearRect(0, 0, els.canvas.width, els.canvas.height);
                        
                        if (els.canvas.width > 0) {
                            els.canvas.width = video.videoWidth;
                            els.canvas.height = video.videoHeight;
                        }
                        
                        if(faceMesh) await faceMesh.send({image: video});
                        if(hands) await hands.send({image: video});
                        
                        checkSOSStatus();

                        frameCount++;
                        const now = Date.now();
                        if (now - lastFpsTime >= 1000) {
                            els.fps.textContent = frameCount;
                            frameCount = 0;
                            lastFpsTime = now;
                        }
                    },
                    width: 1280, height: 720
                });
            }
        }

        async function startSystem() {
            try {
                els.canvas.style.display = 'block';
                els.canvas.style.opacity = '1';

                els.soundSOS.play().then(() => els.soundSOS.pause()).catch(() => {});
                
                isRunning = true;
                systemStartTime = Date.now(); 

                document.getElementById('startBtn').disabled = true;
                document.getElementById('stopBtn').disabled = false;
                document.getElementById('loading').style.display = 'flex';
                document.getElementById('errorMessage').style.display = 'none';

                CONFIG.EAR_THRESHOLD = parseFloat(document.getElementById('earThreshold').value);
                CONFIG.MAR_THRESHOLD = parseFloat(document.getElementById('marThreshold').value);
                CONFIG.SOS_TIMEOUT_MS = parseInt(document.getElementById('sosTimeoutInput').value) * 1000;
                
                const handInput = document.getElementById('handFrameInput');
                if(handInput) CONFIG.HAND_OFF_FRAMES = parseInt(handInput.value);

                await setupAI();
                await camera.start();

                document.getElementById('loading').style.display = 'none';

            } catch (e) {
                console.error(e);
                document.getElementById('errorMessage').textContent = "L·ªói Camera: " + e.message;
                document.getElementById('errorMessage').style.display = 'block';
                stopSystem();
            }
        }

        function stopSystem() {
            console.log("STOPPING SYSTEM...");
            isRunning = false;
            
            if(camera) camera.stop();

            const stream = els.video.srcObject;
            if (stream) {
                const tracks = stream.getTracks();
                tracks.forEach(track => track.stop());
                els.video.srcObject = null;
            }

            document.getElementById('startBtn').disabled = false;
            document.getElementById('stopBtn').disabled = true;
            document.getElementById('loading').style.display = 'none';

            earCounter = 0;
            marCounter = 0;
            handOffCounter = 0;
            yawnTotal = 0;
            alertTotal = 0;
            frameCount = 0;

            document.getElementById('drowsyFramesCount').textContent = '0';
            document.getElementById('yawnCount').textContent = '0';
            document.getElementById('handOffFramesCount').textContent = '0';
            document.getElementById('totalAlerts').textContent = '0';
            els.fps.textContent = '0';
            els.status.textContent = "S·∫µn s√†ng";
            els.dot.style.background = "#10b981";

            els.soundDrowsy.pause();
            els.soundDrowsy.currentTime = 0;
            els.soundHand.pause();
            els.soundHand.currentTime = 0;
            
            dangerStartTime = null;
            isSOSActive = false;
            stopSOS();

            isDrowsyAlerting = false;
            isYawnAlerting = false;
            isHandAlerting = false;
            
            document.getElementById('alertSOS').style.display = 'none';
            document.getElementById('sosTimerDisplay').style.display = 'none';
            els.alertDrowsy.style.display = 'none';
            els.alertHands.style.display = 'none';
            els.alertYawn.style.display = 'none';

            els.ctx.clearRect(0, 0, els.canvas.width, els.canvas.height);
            els.canvas.width = 0;
            els.canvas.height = 0;
            els.canvas.style.display = 'none';
        }

        document.getElementById('startBtn').addEventListener('click', startSystem);
        document.getElementById('stopBtn').addEventListener('click', stopSystem);
        
        document.getElementById('volumeSlider').addEventListener('input', (e) => {
            CONFIG.VOLUME = e.target.value / 100;
            document.getElementById('volumeValue').textContent = e.target.value + '%';
        });
        
        document.getElementById('earThreshold').addEventListener('change', (e) => CONFIG.EAR_THRESHOLD = parseFloat(e.target.value));
        document.getElementById('marThreshold').addEventListener('change', (e) => CONFIG.MAR_THRESHOLD = parseFloat(e.target.value));
        document.getElementById('sosTimeoutInput').addEventListener('change', (e) => CONFIG.SOS_TIMEOUT_MS = parseInt(e.target.value) * 1000);

    </script>
</body>

</html>

